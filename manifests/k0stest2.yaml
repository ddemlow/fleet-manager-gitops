type: Application
version: '1'
metadata:
  description: K0s Kubernetes cluster deployment - GitOps workflow test manual
  clusterGroups:
    - DDvsns
  name: k0s-demo
  lifecycle: production  # This manifest will be deployed to production
  # Optional: specify test cluster group for PR testing (defaults to dd_szt15b)
  testClusterGroup: dd_szt15b
spec:
  assets:
    - name: ubuntu_focal
      type: virtual_disk
      format: raw
      url: "https://storage.googleapis.com/demo-bucket-lfm/focal-server-cloudimg-amd64.img"

  resources: 
    - type: "virdomain"
      name: "k0s-{{clusterName}}"
      spec:
        description: "name {{clusterName}} id {{clusterId}} gitops touch 4 "
        cpu: 4
        memory: "4294967296" #4GB in bytes
        machine_type: "uefi"
        storage_devices:
          - name: "bootdisk"
            type: "virtio_disk"
            source: "ubuntu_focal"
            boot: 1
            capacity: 42949672960  # 40 GB
        network_devices:
          - name: eth0
            type: virtio
        tags:
          - k0s
        state: running
        cloud_init_data:
          user_data: |
            #cloud-config
            # Modern password configuration
            chpasswd:
              list: |
                root:password
                user:password
              expire: false
            
            # SSH configuration
            ssh_pwauth: true
            disable_root: false
            
            # Global SSH keys (applied to all users)
            ssh_authorized_keys:
              - ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIDihWWhjoPj8KVLtdLDwNJQ71zi9An0iUFjefRWu2Eju ddemlow@scalecomputing.com
            
            # User configuration
            ssh_import_id: [gh:ddemlow]
            users:
              - name: user
                groups: [wheel]
                sudo: ALL=(ALL) NOPASSWD:ALL
                shell: /bin/bash
                ssh_authorized_keys:
                  - ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIDihWWhjoPj8KVLtdLDwNJQ71zi9An0iUFjefRWu2Eju ddemlow@scalecomputing.com
            packages:
              - qemu-guest-agent
              - git
              - curl
            runcmd:
              - systemctl restart --no-block qemu-guest-agent
              - curl -sSf https://get.k0s.sh | sh
              - k0s install controller --single
              - k0s start
              - sleep 60
              - export PATH=$PATH:/usr/local/bin
              - k0s kubectl create ns demo2
              - k0s kubectl config set-context --current --namespace=demo2
              - cd /tmp && git clone https://github.com/GoogleCloudPlatform/microservices-demo
              - cd /tmp/microservices-demo
              - k0s kubectl apply -f ./release/kubernetes-manifests.yaml
              - k0s kubectl get pods
              - k0s kubectl get service frontend-external
          meta_data: |
            dsmode: local
            local-hostname: "k0s-{{clusterName}}"