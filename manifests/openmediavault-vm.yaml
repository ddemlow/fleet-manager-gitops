version: "1"
type: "Application"
metadata:
  name: "simple-debian-vm-generic"
  description: "Debian VM that installs and configures OpenMediaVault via cloud-init"
  clusterGroups:
    - dd_szt15b
  lifecycle: production
  labels:
    - storage
    - omv

spec:
  assets:
    - name: debian-base-disk
      type: virtual_disk
      format: raw
      # Replace with a valid Debian 12/13 cloud image in raw format accessible to the hypervisor
      # Example (placeholder): https://your-storage.example.com/images/debian-12-cloud-amd64.raw
      url: "https://cdimage.debian.org/images/cloud/bookworm/latest/debian-12-generic-amd64.raw"

  resources:
    - name: openmediavault-debian
      type: virdomain
      spec:
        description: "OMV on Debian installed using cloud-init runcmd per official docs"
        cpu: 2
        memory: "4294967296"  # 4GiB
        machine_type: bios
        tags:
          - kraken
          - SERIAL
        storage_devices:
          - name: rootdisk
            type: virtio_disk
            source: debian-base-disk
            boot: 1
            capacity: 53687091200  # 50GiB
        network_devices:
          - name: eth0
            type: virtio
        state: running
        cloud_init_data:
          user_data: |
            #cloud-config
            ssh_pwauth: true
            ssh_import_id: ["gh:ddemlow"]
            users:
              - name: admin
                gecos: OMV Admin
                groups: ["sudo"]
                shell: /bin/bash
                sudo: ["ALL=(ALL) NOPASSWD:ALL"]
                lock_passwd: false
            chpasswd:
              users:
                - admin:changeme
              expire: false
            runcmd:
              - apt-get update
              - apt-get install -y gnupg curl ca-certificates
              - DEBIAN_FRONTEND=noninteractive apt-get install -y qemu-guest-agent
              - systemctl enable --now qemu-guest-agent
              - curl -fsSL https://packages.openmediavault.org/public/archive.key | gpg --dearmor -o /etc/apt/trusted.gpg.d/openmediavault.gpg
              - sh -c 'echo "deb [signed-by=/etc/apt/trusted.gpg.d/openmediavault.gpg] https://packages.openmediavault.org/public sandworm main" > /etc/apt/sources.list.d/openmediavault.list'
              - apt-get update
              - DEBIAN_FRONTEND=noninteractive apt-get install -y openmediavault-keyring
              - DEBIAN_FRONTEND=noninteractive apt-get install -y --no-install-recommends openmediavault
              - omv-confdbadm populate

          meta_data: |
            dsmode: local
            instance-id: "openmediavault-debian"
            local-hostname: "openmediavault-debian"


